<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/supercart.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <title>Xác nhận thanh toán</title>
</head>
<style>
    body {
        background-color: #f8d7da; /* Đồng bộ màu nền */
    }

    .navbar {
        background-color: #fff;
        padding: 10px 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .navbar-brand img {
        max-height: 40px;
    }

    .dropdown-toggle {
        padding: 8px 15px;
        margin-right: 15px;
        border: 1px solid transparent;
        background-color: transparent;
        color: #333;
        transition: background-color 0.3s, color 0.3s;
    }

    .dropdown-toggle:hover {
        background-color: #f8d7da;
        color: #000;
    }

    .search-input {
        width: 400px;
        border-radius: 20px 0 0 20px;
        border: 1px solid #f8d7da;
        padding: 10px;
        transition: border 0.3s;
    }

    .search-input:focus {
        border-color: #ff7f7f;
        outline: none;
    }

    .search-button {
        border-radius: 0 20px 20px 0;
        background-color: #f8d7da;
        color: black;
        padding: 10px 15px;
        border: none;
        transition: background-color 0.3s;
    }

    .search-button:hover {
        background-color: #ff7f7f;
    }

    .nav-icons a {
        margin: 0 70px;
        color: black;
        font-size: 24px;
        transition: color 0.3s;
    }

    .nav-icons a:hover {
        color: #ff7f7f;
    }

    .dropdown-menu {
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .dropdown-item {
        color: black;
        transition: background-color 0.3s;
    }

    .dropdown-item:hover {
        background-color: #f0f0f0;
    }

    .dropdown-item img {
        margin-right: 5px;
    }

    h2 {
        color: #333;
    }

    .card-header {
        background-color: #ffffff; /* Màu nền đồng bộ */
        font-weight: bold;
    }

    .product-image {
        width: 100%;
        height: 150px;
    }

    .product-price {
        color: red;
    }

    .btn-dark {
        background-color: #ff9999; /* Sử dụng màu hồng nhạt */
        border: none;
    }

    .btn-dark:hover {
        background-color: #ff9999; /* Màu hồng đậm hơn */
    }

    .btn-dark {
        background-color: #ff9999;
        border: none;
    }

    .btn-dark:hover {
        background-color: #ff9999;
    }

    .product-image {
        width: 100%;
        height: 200px; /* Điều chỉnh chiều cao phù hợp */
        background-color: #f0f0f0; /* Màu nền nếu không có ảnh */
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 10px; /* Bo tròn container */
        overflow: hidden; /* Đảm bảo ảnh không tràn ra ngoài */
    }

    .product-image img {
        width: 100%; /* Chiều rộng đầy đủ */
        height: 100%; /* Chiều cao đầy đủ */
        object-fit: cover; /* Đảm bảo ảnh không bị biến dạng */
    }


</style>
<body>

<nav class="navbar navbar-expand-lg navbar-light">
    <div class="container">
        <a class="navbar-brand" href="#">
            <img src="images/logo.jpg" alt="logo">
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <div class="dropdown me-3">
                <button class="btn dropdown-toggle" type="button" id="categoryDropdown" data-bs-toggle="dropdown"
                        aria-expanded="false">
                    <i class="bi bi-ui-checks-grid"></i> Danh mục
                </button>
                <ul class="dropdown-menu" aria-labelledby="categoryDropdown">
                    <li><a class="dropdown-item" href="#">Sách trong nước</a></li>
                    <li><a class="dropdown-item" href="#">Sách nước ngoài</a></li>
                    <li><a class="dropdown-item" href="#">Đồ chơi</a></li>
                    <li><a class="dropdown-item" href="#">Quà tặng</a></li>
                </ul>
            </div>
            <form class="d-flex me-3">
                <input class="form-control search-input" type="search" placeholder="Nhập từ khóa tìm kiếm"
                       aria-label="Search">
                <button class="btn search-button" type="submit"><i class="bi bi-search"></i></button>
            </form>

            <div class="nav-icons d-flex align-items-center">
                <a href="#" class="me-3"><i class="bi bi-person"></i></a>
                <a href="#" class="me-3"><i class="bi bi-bell"></i></a>
                <a href="#"><i class="bi bi-cart"></i></a>
            </div>
        </div>

        <div class="dropdown me-3">
            <button class="btn dropdown-toggle" type="button" id="languageDropdown" data-bs-toggle="dropdown"
                    aria-expanded="false">
                <img src="images/covietnam.webp" alt="VN" style="width: 20px; height: 15px;">
            </button>
            <ul class="dropdown-menu" aria-labelledby="languageDropdown">
                <li><a class="dropdown-item" href="#"><img src="images/coanh.webp" style="width: 20px; height: 15px;">
                    EN</a></li>
                <li><a class="dropdown-item" href="#"><img src="images/covietnam.webp"
                                                           style="width: 20px; height: 15px;"> VN</a></li>
            </ul>
        </div>
    </div>
</nav>
<div class="container mt-4">
    <h2 class="text-center py-3">Xác nhận thanh toán</h2>

    <!-- Thông báo lỗi nếu giỏ hàng trống -->
    <div th:if="${error}" class="alert alert-warning">
        <p th:text="${error}"></p>
    </div>

    <!-- Địa chỉ nhận hàng -->
    <form id="checkoutForm" method="post">
    <div class="card mb-4">
        <div class="card-header">Địa chỉ nhận hàng</div>
        <div class="card-body">
            <!-- Các trường nhập địa chỉ nhận hàng -->
            <div class="row">
                <div class="col-md-4">
                    <label for="city" class="form-label">Tỉnh, thành phố</label>
                    <select id="city" class="form-select">
                        <option selected>Chọn tỉnh, thành phố...</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label for="district" class="form-label">Quận, huyện</label>
                    <select id="district" class="form-select">
                        <option selected>Chọn quận, huyện...</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label for="ward" class="form-label">Phường, xã</label>
                    <select id="ward" class="form-select">
                        <option selected>Chọn phường, xã...</option>
                    </select>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-md-6">
                    <label for="phone" class="form-label">Số điện thoại</label>
                    <input type="text" id="phone" class="form-control" placeholder="Nhập số điện thoại">
                </div>

                <div class="col-md-6">
                    <label for="additional-info" class="form-label">Địa chỉ chi tiết</label>
                    <textarea id="additional-info" class="form-control" rows="3"
                              placeholder="Nhập địa chỉ chi tiết..."></textarea>
                </div>
            </div>

<!--            <div class="d-grid mt-4">-->
<!--                <button class="btn btn-dark">Lưu thay đổi</button>-->
<!--            </div>-->
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">Sản phẩm trong giỏ hàng</div>
        <div class="card-body">
            <div th:each="sanpham : ${cart}" class="row">
                <div class="col-md-2">
                    <div class="product-image bg-light d-flex align-items-center justify-content-center"
                         style="height: 300px;">
                        <img th:src="'data:image/png;base64,' + ${sanpham.hinh.base64Image}" class="rounded-start"
                             alt="Tên sản phẩm">
                    </div>
                </div>
                <div class="col-md-10">
                    <h5 th:text="${sanpham.tenSach}">Tên sách</h5>
                    <p>Nhà xuất bản: <span th:text="${sanpham.nhaXuatBan}">Nhà xuất bản</span></p>
                    <p>Tác giả: <span th:text="${sanpham.tacGia}">Tác giả</span></p>
                    <p>Thể loại: <span th:text="${sanpham.theLoai}">Thể loại</span></p>
                    <p class="text-danger">
                        Giá: <span th:text="${sanpham.gia}">Giá</span> VND
                    </p>
                    <div class="d-flex align-items-center">
                        <!-- Hiển thị số lượng sản phẩm mà không có input -->
                        <p>Số lượng sản phẩm:
                            <span th:text="${cartQuantity}"
                                  th:attr="data-price=${sanpham.gia}, data-quantity=${cartQuantity}"
                                  class="quantity-display">1</span>
                        </p>


                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <h5 class="text-center">Tổng tiền giỏ hàng: <span class="total-price">0.00</span> VND</h5>
            <!-- Cập nhật phần hiển thị tổng tiền -->
        </div>
    </div>

    <!-- Phương thức thanh toán -->
    <div class="card mb-4">
        <div class="card-header">Phương thức thanh toán</div>
        <div class="card-body">
            <div class="form-check">
                <input type="radio" id="momo" name="payment-method" class="form-check-input">
                <label for="momo" class="form-check-label">
                    <img src="images/Logo-MoMo-Square-1024x1024.webp" alt="" width="20" class="me-2"> Thanh toán MoMo
                </label>
            </div>
            <div class="form-check">
                <input type="radio" id="cod" name="payment-method" class="form-check-input">
                <label for="cod" class="form-check-label">
                    Thanh toán khi nhận hàng
                </label>
            </div>
            <hr>
            <button class="btn btn-dark w-100" type="submit">Xác nhận thanh toán</button>
        </div>
    </div>
    </form>
</div>
<footer class="bg-light text-center text-lg-start mt-5">
    <div class="text-center p-3" style="background-color: rgba(0, 0, 0, 0);">
        © 2024 Bản quyền thuộc về Công ty XYZ. | <a href="#" class="text-dark">Điều khoản dịch vụ</a> | <a href="#"
                                                                                                           class="text-dark">Chính
        sách bảo mật</a>
    </div>
</footer>


<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
<script>
    function updateTotal() {
        let total = 0;
        const quantityDisplays = document.querySelectorAll('.quantity-display');

        // Lặp qua tất cả các span hiển thị số lượng để tính tổng
        quantityDisplays.forEach(display => {
            const priceStr = display.getAttribute('data-price');  // Lấy giá sản phẩm từ thuộc tính data-price
            const price = parseFloat(priceStr);  // Chuyển giá trị thành số

            // Kiểm tra giá trị của price có hợp lệ không
            if (isNaN(price) || price <= 0) {
                console.warn(`Invalid price: ${priceStr}`);  // Ghi ra cảnh báo nếu giá không hợp lệ
                return;  // Bỏ qua sản phẩm này nếu giá không hợp lệ
            }

            const quantityStr = display.getAttribute('data-quantity');  // Lấy số lượng từ thuộc tính data-quantity
            const quantity = parseInt(quantityStr);  // Chuyển giá trị thành số nguyên

            // Kiểm tra xem số lượng có hợp lệ không
            if (!isNaN(quantity) && quantity > 0) {
                total += price * quantity;  // Tính tổng tiền cho mỗi sản phẩm
            }
        });

        // Kiểm tra xem tổng có hợp lệ không
        if (isNaN(total) || total <= 0) {
            total = 0;  // Nếu không hợp lệ, đặt tổng bằng 0
        }

        // Hiển thị tổng tiền lên giao diện
        document.querySelector('.total-price').textContent = new Intl.NumberFormat('vi-VN').format(total);

    }

    // Gọi hàm để tính tổng tiền khi trang được tải
    updateTotal();

    // Lắng nghe sự kiện thay đổi để cập nhật tổng tiền mỗi khi số lượng thay đổi
    document.querySelectorAll('.quantity-input').forEach(input => {
        input.addEventListener('change', updateTotal);
    });

    // Tự động tính tổng khi tải trang
    document.addEventListener('DOMContentLoaded', updateTotal);

    // Hàm tính tổng tiền và trả về giá trị số
    function calculateTotal() {
        let total = 0;
        const quantityDisplays = document.querySelectorAll('.quantity-display');

        quantityDisplays.forEach(display => {
            const price = parseFloat(display.getAttribute('data-price'));
            const quantity = parseInt(display.getAttribute('data-quantity'));
            if (!isNaN(price) && !isNaN(quantity)) {
                total += price * quantity;
            }
        });

        return total;
    }

    // Hàm kiểm tra form
    function validateForm() {
        const city = document.getElementById('city').value;
        const district = document.getElementById('district').value;
        const ward = document.getElementById('ward').value;
        const phone = document.getElementById('phone').value;
        const additionalInfo = document.getElementById('additional-info').value;
        const paymentMethod = document.querySelector('input[name="payment-method"]:checked');

        if (city === 'Chọn tỉnh, thành phố...' || !city) {
            alert('Vui lòng chọn tỉnh, thành phố');
            return false;
        }
        if (district === 'Chọn quận, huyện...' || !district) {
            alert('Vui lòng chọn quận, huyện');
            return false;
        }
        if (ward === 'Chọn phường, xã...' || !ward) {
            alert('Vui lòng chọn phường, xã');
            return false;
        }
        if (!phone || !/^[0-9]{10}$/.test(phone)) {
            alert('Vui lòng nhập số điện thoại hợp lệ (10 số)');
            return false;
        }
        if (!additionalInfo.trim()) {
            alert('Vui lòng nhập địa chỉ chi tiết');
            return false;
        }
        if (!paymentMethod) {
            alert('Vui lòng chọn phương thức thanh toán');
            return false;
        }

        return true;
    }

    // Xử lý sự kiện submit form
    document.querySelector('.btn-dark[type="submit"]').addEventListener('click', function(e) {
        e.preventDefault();

        if (!validateForm()) {
            return;
        }


        const formData = new FormData();
        formData.append('tinh_tp', document.getElementById('city').value);
        formData.append('quan_huyen', document.getElementById('district').value);
        formData.append('phuong_xa', document.getElementById('ward').value);
        formData.append('soDienThoai', document.getElementById('phone').value);
        formData.append('diaChiChiTiet', document.getElementById('additional-info').value);
        formData.append('phuong_thuc_thanh_toan', document.querySelector('input[name="payment-method"]:checked').id);
        formData.append('total', calculateTotal());

        // Hiển thị loading
        const submitButton = this;
        submitButton.disabled = true;
        submitButton.innerHTML = 'Đang xử lý...';

        // Gửi request đến controller
        fetch('processCheckout', {
            method: 'POST',
            body: formData,
        })
            .then(response => {
                if (response.ok) {
                  window.location.href = "checkoutSuccess"
                } else {
                    return response.text().then(text => {
                        throw new Error(text || 'Có lỗi xảy ra trong quá trình thanh toán');
                    });
                }
            })
            .catch(error => {
                alert(error.message);
                if (error.message.includes('đăng nhập')) {
                    window.location.href = '/index/dangNhap';
                }
            })
            .finally(() => {
                // Bỏ trạng thái loading
                submitButton.disabled = false;
                submitButton.innerHTML = 'Xác nhận thanh toán';
            });

    });

    document.addEventListener("DOMContentLoaded", function() {
        // Dữ liệu mẫu cho các tỉnh, quận huyện và phường xã
        const data = {
            "Hà Nội": {
                "Quận Ba Đình": ["Phường Cống Vị", "Phường Giảng Võ", "Phường Điện Biên", "Phường Ngọc Hà", "Phường Kim Mã", "Phường Ba Đình"],
                "Quận Hoàn Kiếm": ["Phường Hàng Bài", "Phường Hàng Trống", "Phường Lý Thái Tổ", "Phường Chương Dương", "Phường Phúc Tân", "Phường Cửa Nam"],
                "Quận Tây Hồ": ["Phường Phú Thượng", "Phường Quảng An", "Phường Thụy Khuê", "Phường Nhật Tân", "Phường Xuân La", "Phường Tây Hồ"],
                "Quận Long Biên": ["Phường Gia Thụy", "Phường Bồ Đề", "Phường Ngọc Thụy", "Phường Phúc Lợi", "Phường Cự Khối", "Phường Thạch Bàn"],
                "Quận Cầu Giấy": ["Phường Dịch Vọng", "Phường Mai Dịch", "Phường Cầu Giấy", "Phường Trung Hòa", "Phường Yên Hòa", "Phường Nghĩa Đô"],
                "Quận Hà Đông": ["Phường Quang Trung", "Phường Phúc La", "Phường La Khê", "Phường Vạn Phúc", "Phường Dương Nội", "Phường Yên Nghĩa"],
                "Quận Đống Đa": ["Phường Cát Linh", "Phường Khâm Thiên", "Phường Trung Liệt", "Phường Ô Chợ Dừa", "Phường Ngã Tư Sở", "Phường Láng Thượng"],
                "Quận Thanh Xuân": ["Phường Khương Mai", "Phường Khương Đình", "Phường Thanh Xuân Bắc", "Phường Hạ Đình", "Phường Linh Đàm", "Phường Nhân Chính"],
                "Quận Bắc Từ Liêm": ["Phường Phú Diễn", "Phường Minh Khai", "Phường Cổ Nhuế 1", "Phường Cổ Nhuế 2", "Phường Đông Ngạc", "Phường Thụy Phương"],
                "Quận Nam Từ Liêm": ["Phường Mễ Trì", "Phường Mỹ Đình 1", "Phường Mỹ Đình 2", "Phường Phương Canh", "Phường Tây Mỗ", "Phường Đại Mỗ"],
                "Huyện Gia Lâm": ["Xã Dương Xá", "Xã Lệ Chi", "Xã Đa Tốn", "Xã Kiêu Kỵ", "Xã Phù Đổng", "Xã Cổ Bi"]
            },
            "Hồ Chí Minh": {
                "Quận 1": ["Phường Bến Nghé", "Phường Bến Thành", "Phường Cô Giang", "Phường Nguyễn Thái Bình", "Phường Đa Kao", "Phường Tân Định"],
                "Quận 2": ["Phường Thạnh Mỹ Lợi", "Phường Bình Trưng Đông", "Phường An Phú", "Phường Cát Lái", "Phường Thảo Điền", "Phường Bình An"],
                "Quận 3": ["Phường Võ Thị Sáu", "Phường Phạm Ngũ Lão", "Phường Đa Kao", "Phường Nguyễn Cư Trinh", "Phường Tân Định", "Phường Cô Giang"],
                "Quận 4": ["Phường 1", "Phường 2", "Phường 3", "Phường 4", "Phường 5", "Phường 6"],
                "Quận 5": ["Phường 1", "Phường 2", "Phường 3", "Phường 4", "Phường 5", "Phường 6"],
                "Quận 6": ["Phường 1", "Phường 2", "Phường 3", "Phường 4", "Phường 5", "Phường 6"],
                "Quận 7": ["Phường Tân Hưng", "Phường Tân Phong", "Phường Tân Quy", "Phường Phú Mỹ", "Phường Bình Thuận", "Phường Hưng Gia"],
                "Quận 8": ["Phường 1", "Phường 2", "Phường 3", "Phường 4", "Phường 5", "Phường 6"],
                "Quận 9": ["Phường Long Bình", "Phường Phước Long A", "Phường Phước Long B", "Phường Tân Phú", "Phường Hiệp Phú", "Phường Trường Thạnh"],
                "Quận 10": ["Phường 1", "Phường 2", "Phường 3", "Phường 4", "Phường 5", "Phường 6"],
                "Quận 11": ["Phường 1", "Phường 2", "Phường 3", "Phường 4", "Phường 5", "Phường 6"],
                "Quận 12": ["Phường Thạnh Lộc", "Phường Thới An", "Phường Tân Thới Hiệp", "Phường Hiệp Thành", "Phường An Phú Đông", "Phường Đông Hưng Thuận"],
                "Huyện Bình Chánh": ["Xã An Phú Tây", "Xã Bình Hưng", "Xã Phong Phú", "Xã Vĩnh Lộc A", "Xã Vĩnh Lộc B", "Xã Hưng Long"],
                "Huyện Nhà Bè": ["Xã Phước Kiển", "Xã Long Thới", "Xã Hiệp Phước", "Xã Nhơn Đức", "Xã Phú Xuân"],
                "Huyện Củ Chi": ["Xã Tân Thông Hội", "Xã Phước Hiệp", "Xã Nhuận Đức", "Xã An Nhơn Tây", "Xã Tân An Hội"],
                "Huyện Hóc Môn": ["Xã Xuân Thới Sơn", "Xã Xuân Thới Thượng", "Xã Tân Hiệp", "Xã Bà Điểm", "Xã Đông Thạnh"]
            },
            "Đà Nẵng": {
                "Quận Hải Châu": ["Phường Bình Hiên", "Phường Bình Thuận", "Phường Cẩm Lệ", "Phường Hòa Thuận Đông", "Phường Hòa Thuận Tây", "Phường Thanh Bình"],
                "Quận Ngũ Hành Sơn": ["Phường Mỹ An", "Phường Mỹ Khê", "Phường Khuê Mỹ", "Phường Hòa Quý", "Phường Phước Mỹ", "Phường Bắc Mỹ An"],
                "Quận Liên Chiểu": ["Phường Hòa Hiệp Bắc", "Phường Hòa Hiệp Nam", "Phường Liên Chiểu", "Phường Lĩnh Nam", "Phường Thanh Bình"],
                "Quận Sơn Trà": ["Phường An Hải Bắc", "Phường An Hải Đông", "Phường Thọ Quang", "Phường Mân Thái", "Phường Phước Mỹ"],
                "Quận Cẩm Lệ": ["Phường Khuê Trung", "Phường Hòa Phát", "Phường Tân Chính", "Phường Hòa An", "Phường Cẩm Nam"],
                "Huyện Hoàng Sa": ["Xã đảo Hoàng Sa", "Xã đảo Sơn Trà"],
                "Huyện Cẩm Lệ": ["Xã Hòa Quý", "Xã Hòa An", "Xã Tân Chính", "Xã Cẩm Nam"]
            },

        };

        const citySelect = document.getElementById("city");
        const districtSelect = document.getElementById("district");
        const wardSelect = document.getElementById("ward");

        // Hàm cập nhật các quận huyện theo tỉnh
        function updateDistricts() {
            const city = citySelect.value;
            districtSelect.innerHTML = '<option selected>Chọn quận, huyện...</option>';
            wardSelect.innerHTML = '<option selected>Chọn phường, xã...</option>';

            if (city && data[city]) {
                Object.keys(data[city]).forEach(district => {
                    const option = document.createElement("option");
                    option.value = district;
                    option.textContent = district;
                    districtSelect.appendChild(option);
                });
            }
        }

        // Hàm cập nhật phường xã theo quận huyện
        function updateWards() {
            const city = citySelect.value;
            const district = districtSelect.value;
            wardSelect.innerHTML = '<option selected>Chọn phường, xã...</option>';

            if (city && district && data[city][district]) {
                data[city][district].forEach(ward => {
                    const option = document.createElement("option");
                    option.value = ward;
                    option.textContent = ward;
                    wardSelect.appendChild(option);
                });
            }
        }

        // Thêm các tỉnh vào danh sách tỉnh thành phố
        Object.keys(data).forEach(city => {
            const option = document.createElement("option");
            option.value = city;
            option.textContent = city;
            citySelect.appendChild(option);
        });

        // Lắng nghe sự thay đổi của tỉnh thành phố và quận huyện
        citySelect.addEventListener("change", updateDistricts);
        districtSelect.addEventListener("change", updateWards);
    });



        // Cập nhật hiển thị tổng tiền khi trang load
    document.addEventListener('DOMContentLoaded', function() {
        const totalPrice = calculateTotal();
        document.querySelector('.total-price').textContent = new Intl.NumberFormat('vi-VN').format(totalPrice);
    });
</script>
<script src="/js/checkout-handler.js"></script>
</body>
</html>

